#!/usr/bin/env node

var cmd = require('commander')
  , prompt = require('cli-prompt')
  , kafs = require('../')
  , spawn = require('child_process').spawn
  , volume

cmd
  .version(require('../package.json').version)
  .description(require('../package.json').description)
  .option('-k, --keyring <dir>', 'Path to keyring volume (default: ~/.kafs/_keyring or env.KAFS_KEYRING)')
  .option('-v, --volume <path>', 'Volume path (default: ~/.kafs/default or env.KAFS_VOLUME)')

cmd
  .command('init [path]')
  .description('Create a new volume at the given path')
  .option('--keypair', 'Generate a keypair to enable rsa encryption')
  .option('--password', 'Encrypt volume with password (implies --keypair)')
  .action(setup(function (path, opts) {
    if (opts.password) {
      (function reConfirm () {
        prompt.password('Create a password: ', function (password) {
          prompt.password('Confirm password: ', function (password2) {
            if (password !== password2) return reConfirm();
            opts.password = password;
            opts.keypair = true;
            doInit();
          });
        });
      })();
    }
    else doInit();

    function doInit () {
      kafs.volume.init(path || process.cwd(), opts, function (err, vol) {
        if (err) throw err;
        console.log('+', vol.id, vol.path());
      });
    }
  }))

cmd
  .command('info')
  .description('Get info about the volume')
  .action(setup(function (opts) {
    console.log(JSON.stringify(volume, null, 2));
  }))

cmd
  .command('write <path>')
  .description('Write a file to the volume')
  .option('-f, --file <src>', 'Read from file path. if not specified, will read STDIN')
  .option('-c, --create', 'Will error if path already exists')
  .action(setup(function (path, opts) {
    console.log('write!', path);
  }))

cmd
  .command('cat <path>')
  .description('Output the contents of a virtual file')
  .action(setup(function (path, opts) {
    console.log('cat!', path);
  }))

cmd
  .command('rm <path>')
  .description('Remove virtual file from volume')
  .action(setup(function (path, opts) {
    console.log('rm!', path);
  }))

cmd
  .command('touch <path>')
  .description('Touch the path')
  .action(setup(function (path, opts) {
    console.log('touch!', path);
  }))

cmd
  .command('stat <path>')
  .option('-f, --file', 'Check for a virtual file')
  .option('-d, --dir', 'Check for a virtual directory')
  .option('-t, --test', 'Return 0 if virtual file/dir exists, 1 otherwise')
  .action(setup(function (path, opts) {
    console.log('stat!', path);
  }))

cmd
  .command('export <dest>')
  .description('Export the volume contents to new directory')
  .option('--exclude <glob>', 'Exclude paths matching glob')
  .option('--include <glob>', 'Include paths matching glob')
  .action(setup(function (dest, opts) {
    console.log('export!', dest);
  }))

cmd
  .command('import <src>')
  .description('Import the contents of a directory into the volume')
  .option('--exclude <glob>', 'Exclude paths matching glob')
  .option('--include <glob>', 'Include paths matching glob')
  .action(setup(function (src, opts) {
    console.log('import!', src);
  }))

cmd
  .command('mount [src] <dest>')
  .description('Mount the volume')
  .option('-r, --readonly', 'Mount read-only')
  .action(setup(function (src, dest, opts) {
    console.log('mount!', src, dest);
  }))

cmd
  .command('server')
  .description('Expose volume via HTTP server')
  .option('-p, --port', 'Port to listen on')
  .option('-r, --root', 'Virtual root path')
  .action(setup(function (opts) {
    console.log('server!');
  }))

cmd
  .command('destroy')
  .description('Destroy the volume')
  .option('-f, --force', 'Force destruction without prompting')
  .action(setup(function (opts) {
    console.log('destroy!');
  }))

cmd
  .command('add-key <key>')
  .description('Add a key to the keyring. Will read STDIN if no argument specified')
  .action(setup(function (arg, opts) {
    console.log('add-key!');
  }))

cmd
  .command('check-key <id>')
  .description('Returns 0 if the keyring has the key, 1 otherwise')
  .action(setup(function (id, opts) {
    console.log('check-key!');
  }))

kafs.env.detect();
cmd.parse(process.argv);

if (typeof cmd.args[cmd.args.length - 1] === 'string') cmd.help();
if (!cmd.args.length) {
  setup(function () {
    cmd.help();
  })(cmd);
}

function setup (cb) {
  return function () {
    var args = arguments
      , opts = args[args.length - 1]

    switch (opts._name) {
      case 'init':
        // init a new volume
        action();
        break;
      case 'add-key': case 'check-key':
        // check keys volume
        process.env.KAFS_VOLUME = process.env.KAFS_KEYRING;
      default:
        // load volume
        kafs.load(process.env.KAFS_VOLUME, {keyring: process.env.KAFS_KEYRING}, function (err, vol) {
          if (err && err.path && err.path.match(/keyring/)) {
            prompt("Looks like you haven't set up a keyring yet. Set one up now? (y) ", function (resp) {
              if (resp.match(/^(y.*|$)/i)) {
                var args = ['init', process.env.KAFS_KEYRING, '--keypair'];
                prompt('Encrypt keyring with password? (y): ', function (resp) {
                  if (resp.match(/^(y.*|$)/i)) args.push('--password');
                  spawn(__filename, args, {stdio: 'inherit'})
                    .on('exit', function () {
                      spawn(__filename, ['init', process.env.KAFS_VOLUME], {stdio: 'inherit'});
                    });
                });
              }
              else action();
            });
            return;
          }
          else if (err) return cb(err);
          volume = vol;
          action();
        });
    }

    function action () {
      cb.apply(null, args);
    }
  };
}